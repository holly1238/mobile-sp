


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>(beta) Efficient mobile interpreter in Android and iOS &mdash; PyTorch Mobile .0 documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!-- <link rel="stylesheet" href="../_static/pygments.css" type="text/css" /> -->
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
  <!-- Google Analytics -->
  
  <!-- End Google Analytics -->
  

  
  <script src="../_static/js/modernizr.min.js"></script>

  <!-- Preload the theme fonts -->

<link rel="preload" href="../_static/fonts/FreightSans/freight-sans-book.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../_static/fonts/FreightSans/freight-sans-medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../_static/fonts/IBMPlexMono/IBMPlexMono-Medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../_static/fonts/FreightSans/freight-sans-bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../_static/fonts/FreightSans/freight-sans-medium-italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../_static/fonts/IBMPlexMono/IBMPlexMono-SemiBold.woff2" as="font" type="font/woff2" crossorigin="anonymous">

<!-- Preload the katex fonts -->

<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Math-Italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size1-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size4-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size2-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size3-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Caligraphic-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css" integrity="sha384-vSIIfh2YWi9wW0r9iZe7RJPrKwp6bG+s9QZMoITbCckVJqGCCRhc+ccxNcdpHuYu" crossorigin="anonymous">
</head>

<div class="container-fluid header-holder tutorials-header" id="header-holder">
  <div class="container">
    <div class="header-container">
      <a class="header-logo" href="https://pytorch.org/" aria-label="PyTorch"></a>

      <div class="main-menu">
        <ul>
          <li>
            <a href="https://pytorch.org/get-started">Get Started</a>
          </li>

          <li>
            <a href="https://pytorch.org/ecosystem">Ecosystem</a>
          </li>

          <li>
            <a href="https://pytorch.org/mobile">Mobile</a>
          </li>

          <li>
            <a href="https://pytorch.org/blog/">Blog</a>
          </li>

          <li>
            <a href="https://pytorch.org/tutorials">Tutorials</a>
          </li>

          <li>
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="resource-option with-down-orange-arrow">
                Docs
              </a>
              <div class="resources-dropdown-menu">
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/docs/stable/index.html">
                  <span class="dropdown-title">PyTorch</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/audio/stable/index.html">
                  <span class="dropdown-title">torchaudio</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/text/stable/index.html">
                  <span class="dropdown-title">torchtext</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/vision/stable/index.html">
                  <span class="dropdown-title">torchvision</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/elastic/">
                  <span class="dropdown-title">TorchElastic</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/serve/">
                  <span class="dropdown-title">TorchServe</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/xla">
                  <span class="dropdown-title">PyTorch on XLA Devices</span>
                  <p></p>
                </a>
            </div>
          </li>

          <li>
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="resource-option with-down-arrow">
                Resources
              </a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="https://pytorch.org/features">
                  <span class="dropdown-title">About</span>
                  <p>Learn about PyTorch’s features and capabilities</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/#community-module">
                  <span class="dropdown-title">Community</span>
                  <p>Join the PyTorch developer community to contribute, learn, and get your questions answered.</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/resources">
                  <span class="dropdown-title">Developer Resources</span>
                  <p>Find resources and get questions answered</p>
                </a>
                <a class="nav-dropdown-item" href="https://discuss.pytorch.org/" target="_blank">
                  <span class="dropdown-title">Forums</span>
                  <p>A place to discuss PyTorch code, issues, install, research</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/hub">
                  <span class="dropdown-title">Models (Beta)</span>
                  <p>Discover, publish, and reuse pre-trained models</p>
                </a>
              </div>
            </div>
          </li>

          <li>
            <a href="https://github.com/pytorch/pytorch">GitHub</a>
          </li>
        </ul>
      </div>

      <a class="main-menu-open-button" href="#" data-behavior="open-mobile-menu"></a>
    </div>
  </div>
</div>

<body class="pytorch-body">

   

    

    <div class="table-of-contents-link-wrapper">
      <span>Table of Contents</span>
      <a href="#" class="toggle-table-of-contents" data-behavior="toggle-table-of-contents"></a>
    </div>

    <nav data-toggle="wy-nav-shift" class="pytorch-left-menu" id="pytorch-left-menu">
      <div class="pytorch-side-scroll">
        <div class="pytorch-menu pytorch-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          <div class="pytorch-left-menu-search">
            

            
              
              
            

            


  


<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search Docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

            
          </div>

          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Overview</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../index.html">PyTorch Mobile</a></li>
<li class="toctree-l1"><a class="reference internal" href="../deploymentWorkflow.html">Deployment Workflow</a></li>
</ul>
<p class="caption"><span class="caption-text">Quickstart</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../quickstarts/androidquickstart.html">Android Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickstarts/iosquickstart.html">iOS Quickstart</a></li>
</ul>
<p class="caption"><span class="caption-text">Build From Source</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../androidsourcebuild.html">Building PyTorch Android from Source</a></li>
<li class="toctree-l1"><a class="reference internal" href="../iossourcebuild.html">Building PyTorch iOS from Source</a></li>
</ul>
<p class="caption"><span class="caption-text">Binary Size Optimization</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../selectivebuild/andriodSelectiveBuild.html">Andriod Selective Build</a></li>
<li class="toctree-l1"><a class="reference internal" href="../selectivebuild/iosSelectiveBuild.html">iOS Selective Build</a></li>
</ul>
<p class="caption"><span class="caption-text">Using PyTorch Libraries</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../usinglibraries/usingAndroidLibraries.html">Using the PyTorch Android Libraries</a></li>
<li class="toctree-l1"><a class="reference internal" href="../usinglibraries/usingiosLibraries.html">Using the PyTorch iOS Libraries</a></li>
</ul>
<p class="caption"><span class="caption-text">Model Preparation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="modelPrepAndroid.html">Model Preparation for Android</a></li>
<li class="toctree-l1"><a class="reference internal" href="modelPrepiOS.html">Model Preparation for iOS</a></li>
<li class="toctree-l1"><a class="reference internal" href="quantization.html">Quantization</a></li>
<li class="toctree-l1"><a class="reference internal" href="scriptOptimizeMobile.html">Script and Optimize for Mobile</a></li>
<li class="toctree-l1"><a class="reference internal" href="liteJitInterpreters.html">PyTorch Lite and Jit Interpreters</a></li>
</ul>
<p class="caption"><span class="caption-text">Performance</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../performance/bestPractices.html">Pytorch Mobile Performance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../performance/fuseModules.html">Fuse Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../performance/andriodBenchmark.html">Andriod Benchmarking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../performance/iosBenchmark.html">iOS Benchmarking</a></li>
</ul>
<p class="caption"><span class="caption-text">Backends</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../backends/GPUandroid.html">Using GPU on Andriod (Vulkan Backend)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../backends/GPUiOS.html">Using GPU on iOS (Metal Backend)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../backends/NNAPIandroid.html">Convert MobileNetV2 to NNAPI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../backends/coreMLios.html">Core ML on iOS</a></li>
</ul>
<p class="caption"><span class="caption-text">Custom Operators</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../customOperators.html">Andriod Native Application with Custom Operators</a></li>
</ul>
<p class="caption"><span class="caption-text">Run Inference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../runInference.html">Operator Compatibility</a></li>
</ul>
<p class="caption"><span class="caption-text">Video Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../videos/runtimeAndroid.html">PyTorch Mobile Runtime for Android</a></li>
<li class="toctree-l1"><a class="reference internal" href="../videos/runtimeiOS.html">PyTorch Mobile Runtime for iOS</a></li>
</ul>
<p class="caption"><span class="caption-text">Android Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://github.com/pytorch/android-demo-app">All Android Demo Apps</a></li>
<li class="toctree-l1"><a class="reference internal" href="../androidTutorials/androidD2Go.html">Android D2Go</a></li>
<li class="toctree-l1"><a class="reference internal" href="../androidTutorials/androidImageSegmentation.html">Image Segmentation DeepLabV3 on Android</a></li>
<li class="toctree-l1"><a class="reference internal" href="../androidTutorials/androidObjectDetection.html">Android Object Detection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../androidTutorials/androidNeuralMachineTranslation.html">Android Neural Machine Translation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../androidTutorials/androidQuestionAnswering.html">Android Question Answering</a></li>
<li class="toctree-l1"><a class="reference internal" href="../androidTutorials/androidVisionTransformer.html">Android Vision Transformer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../androidTutorials/androidSpeechRecognition.html">Android Speech Recognition</a></li>
<li class="toctree-l1"><a class="reference internal" href="../androidTutorials/androidVideoClassification.html">Android Video Classification</a></li>
</ul>
<p class="caption"><span class="caption-text">iOS Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://github.com/pytorch/ios-demo-app">All iOS Demo Apps</a></li>
<li class="toctree-l1"><a class="reference internal" href="../iosTutorials/iosD2Go.html">iOS D2Go</a></li>
<li class="toctree-l1"><a class="reference internal" href="../iosTutorials/iosImageSegmentation.html">Image Segmentation DeepLabV3 on iOS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../iosTutorials/iosObjectDetection.html">iOS Object Detection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../iosTutorials/iosNeuralMachineTranslation.html">iOS Neural Machine Translation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../iosTutorials/iosQuestionAnswering.html">iOS Question Answering</a></li>
<li class="toctree-l1"><a class="reference internal" href="../iosTutorials/iosVisionTransformer.html">iOS Vision Transformer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../iosTutorials/iosSpeechRecognition.html">iOS Speech Recognition</a></li>
<li class="toctree-l1"><a class="reference internal" href="../iosTutorials/iosVideoClassification.html">iOS Video Classification</a></li>
</ul>
<p class="caption"><span class="caption-text">API Docs</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api.html">Mobile API Docs</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <div class="pytorch-container">
      <div class="pytorch-page-level-bar" id="pytorch-page-level-bar">
        <div class="pytorch-breadcrumbs-wrapper">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="pytorch-breadcrumbs">
    
      <li>
        <a href="../contents.html">
          
            Docs
          
        </a> &gt;
      </li>

        
      <li>(beta) Efficient mobile interpreter in Android and iOS</li>
    
    
      <li class="pytorch-breadcrumbs-aside">
        
            
            <a href="../_sources/modelprep/mobileInterpreter.rst.txt" rel="nofollow"><img src="../_static/images/view-page-source-icon.svg"></a>
          
        
      </li>
    
  </ul>

  
</div>
        </div>

        <div class="pytorch-shortcuts-wrapper" id="pytorch-shortcuts-wrapper">
          Shortcuts
        </div>
      </div>

      <section data-toggle="wy-nav-shift" id="pytorch-content-wrap" class="pytorch-content-wrap">
        <div class="pytorch-content-left">

        
          
          <div class="rst-content">
          
            <div role="main" class="main-content" itemscope="itemscope" itemtype="http://schema.org/Article">
             <article itemprop="articleBody" id="pytorch-article" class="pytorch-article">
              
  <div class="section" id="beta-efficient-mobile-interpreter-in-android-and-ios">
<h1>(beta) Efficient mobile interpreter in Android and iOS<a class="headerlink" href="#beta-efficient-mobile-interpreter-in-android-and-ios" title="Permalink to this headline">¶</a></h1>
<p><strong>Author</strong>: <a class="reference external" href="https://github.com/cccclai">Chen Lai</a>, <a class="reference external" href="https://github.com/iseeyuan">Martin Yuan</a></p>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>This tutorial introduces the steps to use PyTorch’s efficient interpreter on iOS and Android. We will be using an  Image Segmentation demo application as an example.</p>
<p>This application will take advantage of the pre-built interpreter libraries available for Android and iOS, which can be used directly with Maven (Android) and CocoaPods (iOS). It is important to note that the pre-built libraries are the available for simplicity, but further size optimization can be achieved with by utilizing PyTorch’s custom build capabilities.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>If you see the error message: <cite>PytorchStreamReader failed locating file bytecode.pkl: file not found ()</cite>, likely you are using a torch script model that requires the use of the PyTorch JIT interpreter (a version of our PyTorch interpreter that is not as size-efficient). In order to leverage our efficient interpreter, please regenerate the model by running: <cite>module._save_for_lite_interpreter(${model_path})</cite>.</p>
<ul class="last simple">
<li>If <cite>bytecode.pkl</cite> is missing, likely the model is generated with the api: <cite>module.save(${model_psth})</cite>.</li>
<li>The api <cite>_load_for_lite_interpreter(${model_psth})</cite> can be helpful to validate model with the efficient mobile interpreter.</li>
</ul>
</div>
</div>
<div class="section" id="android">
<h2>Android<a class="headerlink" href="#android" title="Permalink to this headline">¶</a></h2>
<p>Get the Image Segmentation demo app in Android: <a class="reference external" href="https://github.com/pytorch/android-demo-app/tree/master/ImageSegmentation">https://github.com/pytorch/android-demo-app/tree/master/ImageSegmentation</a></p>
<ol class="arabic simple">
<li><strong>Prepare model</strong>: Prepare the mobile interpreter version of model by run the script below to generate the scripted model <cite>deeplabv3_scripted.pt</cite> and <cite>deeplabv3_scripted.ptl</cite></li>
</ol>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">torch.utils.mobile_optimizer</span> <span class="k">import</span> <span class="n">optimize_for_mobile</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">hub</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;pytorch/vision:v0.7.0&#39;</span><span class="p">,</span> <span class="s1">&#39;deeplabv3_resnet50&#39;</span><span class="p">,</span> <span class="n">pretrained</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>

<span class="n">scripted_module</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">jit</span><span class="o">.</span><span class="n">script</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
<span class="c1"># Export full jit version model (not compatible mobile interpreter), leave it here for comparison</span>
<span class="n">scripted_module</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;deeplabv3_scripted.pt&quot;</span><span class="p">)</span>
<span class="c1"># Export mobile interpreter version model (compatible with mobile interpreter)</span>
<span class="n">optimized_scripted_module</span> <span class="o">=</span> <span class="n">optimize_for_mobile</span><span class="p">(</span><span class="n">scripted_module</span><span class="p">)</span>
<span class="n">optimized_scripted_module</span><span class="o">.</span><span class="n">_save_for_lite_interpreter</span><span class="p">(</span><span class="s2">&quot;deeplabv3_scripted.ptl&quot;</span><span class="p">)</span>
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><strong>Use the PyTorch Android library in the ImageSegmentation app</strong>: Update the <cite>dependencies</cite> part of <code class="docutils literal notranslate"><span class="pre">ImageSegmentation/app/build.gradle</span></code> to</li>
</ol>
<ol class="arabic simple" start="3">
<li><strong>Update model loader api</strong>: Update <code class="docutils literal notranslate"><span class="pre">ImageSegmentation/app/src/main/java/org/pytorch/imagesegmentation/MainActivity.java</span></code> by</li>
</ol>
<blockquote>
<div><p>4.1 Add new import: <cite>import org.pytorch.LiteModuleLoader</cite></p>
<p>4.2 Replace the way to load pytorch lite model</p>
</div></blockquote>
<div class="code java highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">mModule</span> <span class="o">=</span> <span class="n">Module</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">MainActivity</span><span class="o">.</span><span class="n">assetFilePath</span><span class="p">(</span><span class="n">getApplicationContext</span><span class="p">(),</span> <span class="s2">&quot;deeplabv3_scripted.pt&quot;</span><span class="p">));</span>
<span class="n">mModule</span> <span class="o">=</span> <span class="n">LiteModuleLoader</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">MainActivity</span><span class="o">.</span><span class="n">assetFilePath</span><span class="p">(</span><span class="n">getApplicationContext</span><span class="p">(),</span> <span class="s2">&quot;deeplabv3_scripted.ptl&quot;</span><span class="p">));</span>
</pre></div>
</div>
<ol class="arabic simple" start="4">
<li><strong>Test app</strong>: Build and run the <cite>ImageSegmentation</cite> app in Android Studio</li>
</ol>
</div>
<div class="section" id="ios">
<h2>iOS<a class="headerlink" href="#ios" title="Permalink to this headline">¶</a></h2>
<p>Get ImageSegmentation demo app in iOS: <a class="reference external" href="https://github.com/pytorch/ios-demo-app/tree/master/ImageSegmentation">https://github.com/pytorch/ios-demo-app/tree/master/ImageSegmentation</a></p>
<ol class="arabic simple">
<li><strong>Prepare model</strong>: Same as Android.</li>
<li><strong>Build the project with Cocoapods and prebuilt interpreter</strong> Update the <cite>PodFile</cite> and run <cite>pod install</cite>:</li>
</ol>
<div class="highlight-podfile notranslate"><div class="highlight"><pre><span></span>target &#39;ImageSegmentation&#39; do
# Comment the next line if you don&#39;t want to use dynamic frameworks
use_frameworks!

# Pods for ImageSegmentation
pod &#39;LibTorch_Lite&#39;, &#39;~&gt;1.9.0&#39;
end
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li><strong>Update library and API</strong></li>
</ol>
<blockquote>
<div>3.1 Update <code class="docutils literal notranslate"><span class="pre">TorchModule.mm</span></code>: To use the custom built libraries project, use <cite>&lt;Libtorch-Lite.h&gt;</cite> (in <code class="docutils literal notranslate"><span class="pre">TorchModule.mm</span></code>):</div></blockquote>
<div class="highlight-swift notranslate"><div class="highlight"><pre><span></span><span class="p">#</span><span class="kd">import</span> <span class="p">&lt;</span><span class="nc">Libtorch</span><span class="o">-</span><span class="nc">Lite</span><span class="p">.</span><span class="nc">h</span><span class="p">&gt;</span>
<span class="c1">// If it&#39;s built from source with xcode, comment out the line above</span>
<span class="c1">// and use following headers</span>
<span class="c1">// #include &lt;torch/csrc/jit/mobile/import.h&gt;</span>
<span class="c1">// #include &lt;torch/csrc/jit/mobile/module.h&gt;</span>
<span class="c1">// #include &lt;torch/script.h&gt;</span>
</pre></div>
</div>
<div class="highlight-swift notranslate"><div class="highlight"><pre><span></span><span class="p">@</span><span class="n">implementation</span> <span class="n">TorchModule</span> <span class="p">{</span>
<span class="p">@</span><span class="n">protected</span>
<span class="c1">// torch::jit::script::Module _impl;</span>
 <span class="n">torch</span><span class="p">::</span><span class="n">jit</span><span class="p">::</span><span class="n">mobile</span><span class="p">::</span><span class="n">Module</span> <span class="n">_impl</span><span class="p">;</span>
<span class="p">}</span>

<span class="o">-</span> <span class="p">(</span><span class="n">nullable</span> <span class="n">instancetype</span><span class="p">)</span><span class="n">initWithFileAtPath</span><span class="p">:(</span><span class="bp">NSString</span><span class="o">*</span><span class="p">)</span><span class="n">filePath</span> <span class="p">{</span>
  <span class="kc">self</span> <span class="p">=</span> <span class="p">[</span><span class="kc">super</span> <span class="kd">init</span><span class="p">];</span>
  <span class="k">if</span> <span class="p">(</span><span class="kc">self</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">try</span> <span class="p">{</span>
          <span class="n">_impl</span> <span class="p">=</span> <span class="n">torch</span><span class="p">::</span><span class="n">jit</span><span class="p">::</span><span class="n">_load_for_mobile</span><span class="p">(</span><span class="n">filePath</span><span class="p">.</span><span class="n">UTF8String</span><span class="p">);</span>
         <span class="c1">//  _impl = torch::jit::load(filePath.UTF8String);</span>
         <span class="c1">//  _impl.eval();</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">const</span> <span class="n">std</span><span class="p">::</span><span class="n">exception</span><span class="o">&amp;</span> <span class="n">exception</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">NSLog</span><span class="p">(@</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">exception</span><span class="p">.</span><span class="n">what</span><span class="p">());</span>
            <span class="k">return</span> <span class="kc">nil</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kc">self</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>3.2 Update <code class="docutils literal notranslate"><span class="pre">ViewController.swift</span></code></p>
<div class="highlight-swift notranslate"><div class="highlight"><pre><span></span><span class="c1">//  if let filePath = Bundle.main.path(forResource:</span>
<span class="c1">//      &quot;deeplabv3_scripted&quot;, ofType: &quot;pt&quot;),</span>
<span class="c1">//      let module = TorchModule(fileAtPath: filePath) {</span>
<span class="c1">//      return module</span>
<span class="c1">//  } else {</span>
<span class="c1">//      fatalError(&quot;Can&#39;t find the model file!&quot;)</span>
<span class="c1">//  }</span>
<span class="k">if</span> <span class="kd">let</span> <span class="nv">filePath</span> <span class="p">=</span> <span class="n">Bundle</span><span class="p">.</span><span class="n">main</span><span class="p">.</span><span class="n">path</span><span class="p">(</span><span class="n">forResource</span><span class="p">:</span>
    <span class="s">&quot;deeplabv3_scripted&quot;</span><span class="p">,</span> <span class="n">ofType</span><span class="p">:</span> <span class="s">&quot;ptl&quot;</span><span class="p">),</span>
    <span class="kd">let</span> <span class="nv">module</span> <span class="p">=</span> <span class="n">TorchModule</span><span class="p">(</span><span class="n">fileAtPath</span><span class="p">:</span> <span class="n">filePath</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">module</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="bp">fatalError</span><span class="p">(</span><span class="s">&quot;Can&#39;t find the model file!&quot;</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<ol class="arabic simple" start="4">
<li>Build and test the app in Xcode.</li>
</ol>
</div>
<div class="section" id="how-to-use-mobile-interpreter-custom-build">
<h2>How to use mobile interpreter + custom build<a class="headerlink" href="#how-to-use-mobile-interpreter-custom-build" title="Permalink to this headline">¶</a></h2>
<p>A custom PyTorch interpreter library can be created to reduce binary size, by only containing the operators needed by the model. In order to do that follow these steps:</p>
<ol class="arabic simple">
<li>To dump the operators in your model, say <cite>deeplabv3_scripted</cite>, run the following lines of Python code:</li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Dump list of operators used by deeplabv3_scripted:</span>
<span class="kn">import</span> <span class="nn">torch</span><span class="o">,</span> <span class="nn">yaml</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">jit</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;deeplabv3_scripted.ptl&#39;</span><span class="p">)</span>
<span class="n">ops</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">jit</span><span class="o">.</span><span class="n">export_opnames</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;deeplabv3_scripted.yaml&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">output</span><span class="p">:</span>
    <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">ops</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
</pre></div>
</div>
<p>In the snippet above, you first need to load the ScriptModule. Then, use export_opnames to return a list of operator names of the ScriptModule and its submodules. Lastly, save the result in a yaml file. The yaml file can be generated for any PyTorch 1.4.0 or above version. You can do that by checking the value of <cite>torch.__version__</cite>.</p>
<ol class="arabic simple" start="2">
<li>To run the build script locally with the prepared yaml list of operators, pass in the yaml file generate from the last step into the environment variable SELECTED_OP_LIST. Also in the arguments, specify BUILD_PYTORCH_MOBILE=1 as well as the platform/architechture type.</li>
</ol>
<p><strong>iOS</strong>: Take the simulator build for example, the command should be:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">SELECTED_OP_LIST</span><span class="o">=</span>deeplabv3_scripted.yaml <span class="nv">BUILD_PYTORCH_MOBILE</span><span class="o">=</span><span class="m">1</span> <span class="nv">IOS_PLATFORM</span><span class="o">=</span>SIMULATOR ./scripts/build_ios.sh
</pre></div>
</div>
<p><strong>Android</strong>: Take the x86 build for example, the command should be:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">SELECTED_OP_LIST</span><span class="o">=</span>deeplabv3_scripted.yaml ./scripts/build_pytorch_android.sh x86
</pre></div>
</div>
</div>
<div class="section" id="conclusion">
<h2>Conclusion<a class="headerlink" href="#conclusion" title="Permalink to this headline">¶</a></h2>
<p>In this tutorial, we demonstrated how to use PyTorch’s efficient mobile interpreter, in an Android and iOS app.</p>
<p>We walked through an Image Segmentation example to show how to dump the model, build a custom torch library from source and use the new api to run model.</p>
<p>Our efficient mobile interpreter is still under development, and we will continue improving its size in the future. Note, however, that the APIs are subject to change in future versions.</p>
<p>Thanks for reading! As always, we welcome any feedback, so please create an issue <cite>here &lt;https://github.com/pytorch/pytorch/issues&gt;</cite> - if you have any.</p>
</div>
<div class="section" id="learn-more">
<h2>Learn More<a class="headerlink" href="#learn-more" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>To learn more about Image Segmentation, please refer to the <a class="reference external" href="https://pytorch.org/tutorials/beginner/deeplabv3_on_android.html">Image Segmentation DeepLabV3 on Android Recipe</a></li>
</ul>
</div>
</div>


             </article>
             
            </div>
            <footer>
  

  

    <hr>

  

  <div role="contentinfo">
    <p>
        &copy; Copyright 2021, Facebook.

    </p>
  </div>
    
      <div>
        Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
      </div>
     

</footer>

          </div>
        </div>

        <div class="pytorch-content-right" id="pytorch-content-right">
          <div class="pytorch-right-menu" id="pytorch-right-menu">
            <div class="pytorch-side-scroll" id="pytorch-side-scroll-right">
              <ul>
<li><a class="reference internal" href="#">(beta) Efficient mobile interpreter in Android and iOS</a><ul>
<li><a class="reference internal" href="#introduction">Introduction</a></li>
<li><a class="reference internal" href="#android">Android</a></li>
<li><a class="reference internal" href="#ios">iOS</a></li>
<li><a class="reference internal" href="#how-to-use-mobile-interpreter-custom-build">How to use mobile interpreter + custom build</a></li>
<li><a class="reference internal" href="#conclusion">Conclusion</a></li>
<li><a class="reference internal" href="#learn-more">Learn More</a></li>
</ul>
</li>
</ul>

            </div>
          </div>
        </div>
      </section>
    </div>

  


  

     
       <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
         <script type="text/javascript" src="../_static/jquery.js"></script>
         <script type="text/javascript" src="../_static/underscore.js"></script>
         <script type="text/javascript" src="../_static/doctools.js"></script>
         <script type="text/javascript" src="../_static/language_data.js"></script>
     

  

  <script type="text/javascript" src="../_static/js/vendor/popper.min.js"></script>
  <script type="text/javascript" src="../_static/js/vendor/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/list.js/1.5.0/list.min.js"></script>
  <script type="text/javascript" src="../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>  

  <style>
    /* Sidebar header (and topbar for mobile) */
    .wy-side-nav-search, .wy-nav-top {
      background: #00ff00;
    }
    /* Sidebar */
    .wy-nav-side {
      background: #E73422;
    }
  </style>

<script script type="text/javascript">
  var collapsedSections = ['Quickstart', 'Build From Source', 'Binary Size Optimization', 'Using PyTorch Libraries', 'Model Preparation', 'Performance', 'Backends', 'Custom Operators', 'Run Inference', 'Video Tutorials', 'Android Tutorials', 'iOS Tutorials', 'API Docs'];
</script>
  


  <!-- Begin Footer -->

  <div class="container-fluid docs-tutorials-resources" id="docs-tutorials-resources">
    <div class="container">
      <div class="row">
        <div class="col-md-4 text-center">
          <h2>Docs</h2>
          <p>Access comprehensive developer documentation for PyTorch</p>
          <a class="with-right-arrow" href="https://pytorch.org/docs/stable/index.html">View Docs</a>
        </div>

        <div class="col-md-4 text-center">
          <h2>Tutorials</h2>
          <p>Get in-depth tutorials for beginners and advanced developers</p>
          <a class="with-right-arrow" href="https://pytorch.org/tutorials">View Tutorials</a>
        </div>

        <div class="col-md-4 text-center">
          <h2>Resources</h2>
          <p>Find development resources and get your questions answered</p>
          <a class="with-right-arrow" href="https://pytorch.org/resources">View Resources</a>
        </div>
      </div>
    </div>
  </div>

  <footer class="site-footer">
    <div class="container footer-container">
      <div class="footer-logo-wrapper">
        <a href="https://pytorch.org/" class="footer-logo"></a>
      </div>

      <div class="footer-links-wrapper">
        <div class="footer-links-col">
          <ul>
            <li class="list-title"><a href="https://pytorch.org/">PyTorch</a></li>
            <li><a href="https://pytorch.org/get-started">Get Started</a></li>
            <li><a href="https://pytorch.org/features">Features</a></li>
            <li><a href="https://pytorch.org/ecosystem">Ecosystem</a></li>
            <li><a href="https://pytorch.org/blog/">Blog</a></li>
            <li><a href="https://github.com/pytorch/pytorch/blob/master/CONTRIBUTING.md">Contributing</a></li>
          </ul>
        </div>

        <div class="footer-links-col">
          <ul>
            <li class="list-title"><a href="https://pytorch.org/resources">Resources</a></li>
            <li><a href="https://pytorch.org/tutorials">Tutorials</a></li>
            <li><a href="https://pytorch.org/docs/stable/index.html">Docs</a></li>
            <li><a href="https://discuss.pytorch.org" target="_blank">Discuss</a></li>
            <li><a href="https://github.com/pytorch/pytorch/issues" target="_blank">Github Issues</a></li>
            <li><a href="https://pytorch.org/assets/brand-guidelines/PyTorch-Brand-Guidelines.pdf" target="_blank">Brand Guidelines</a></li>
          </ul>
        </div>

        <div class="footer-links-col follow-us-col">
          <ul>
            <li class="list-title">Stay Connected</li>
            <li>
              <div id="mc_embed_signup">
                <form
                  action="https://twitter.us14.list-manage.com/subscribe/post?u=75419c71fe0a935e53dfa4a3f&id=91d0dccd39"
                  method="post"
                  id="mc-embedded-subscribe-form"
                  name="mc-embedded-subscribe-form"
                  class="email-subscribe-form validate"
                  target="_blank"
                  novalidate>
                  <div id="mc_embed_signup_scroll" class="email-subscribe-form-fields-wrapper">
                    <div class="mc-field-group">
                      <label for="mce-EMAIL" style="display:none;">Email Address</label>
                      <input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL" placeholder="Email Address">
                    </div>

                    <div id="mce-responses" class="clear">
                      <div class="response" id="mce-error-response" style="display:none"></div>
                      <div class="response" id="mce-success-response" style="display:none"></div>
                    </div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->

                    <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_75419c71fe0a935e53dfa4a3f_91d0dccd39" tabindex="-1" value=""></div>

                    <div class="clear">
                      <input type="submit" value="" name="subscribe" id="mc-embedded-subscribe" class="button email-subscribe-button">
                    </div>
                  </div>
                </form>
              </div>

            </li>
          </ul>

          <div class="footer-social-icons">
            <a href="https://www.facebook.com/pytorch" target="_blank" class="facebook"></a>
            <a href="https://twitter.com/pytorch" target="_blank" class="twitter"></a>
            <a href="https://www.youtube.com/pytorch" target="_blank" class="youtube"></a>
          </div>
        </div>
      </div>
    </div>
  </footer>

  <div class="cookie-banner-wrapper">
  <div class="container">
    <p class="gdpr-notice">To analyze traffic and optimize your experience, we serve cookies on this site. By clicking or navigating, you agree to allow our usage of cookies. As the current maintainers of this site, Facebook’s Cookies Policy applies. Learn more, including about available controls: <a href="https://www.facebook.com/policies/cookies/">Cookies Policy</a>.</p>
    <img class="close-button" src="../_static/images/pytorch-x.svg">
  </div>
</div>

  <!-- End Footer -->

  <!-- Begin Mobile Menu -->

  <div class="mobile-main-menu">
    <div class="container-fluid">
      <div class="container">
        <div class="mobile-main-menu-header-container">
          <a class="header-logo" href="https://pytorch.org/" aria-label="PyTorch"></a>
          <a class="main-menu-close-button" href="#" data-behavior="close-mobile-menu"></a>
        </div>
      </div>
    </div>

    <div class="mobile-main-menu-links-container">
      <div class="main-menu">
        <ul>
          <li>
            <a href="https://pytorch.org/get-started">Get Started</a>
          </li>

          <li>
            <a href="https://pytorch.org/ecosystem">Ecosystem</a>
          </li>

          <li>
            <a href="https://pytorch.org/mobile">Mobile</a>
          </li>

          <li>
            <a href="https://pytorch.org/hub">PyTorch Hub</a>
          </li>

          <li>
            <a href="https://pytorch.org/blog/">Blog</a>
          </li>

          <li>
            <a href="https://pytorch.org/tutorials">Tutorials</a>
          </li>

          <li class="resources-mobile-menu-title">
            Docs
          </li>

          <ul class="resources-mobile-menu-items">
            <li>
              <a href="https://pytorch.org/docs/stable/index.html">PyTorch</a>
            </li>

            <li>
              <a href="https://pytorch.org/audio/stable/index.html">torchaudio</a>
            </li>

            <li>
              <a href="https://pytorch.org/text/stable/index.html">torchtext</a>
            </li>

            <li>
              <a href="https://pytorch.org/vision/stable/index.html">torchvision</a>
            </li>

            <li>
              <a href="https://pytorch.org/elastic/">TorchElastic</a>
            </li>

            <li>
              <a href="https://pytorch.org/serve/">TorchServe</a>
            </li>

            <li>
              <a href="https://pytorch.org/xla">PyTorch on XLA Devices</a>
            </li>
          </ul>

          <li class="resources-mobile-menu-title">
            Resources
          </li>

          <ul class="resources-mobile-menu-items">
            <li>
              <a href="https://pytorch.org/resources">Developer Resources</a>
            </li>

            <li>
              <a href="https://pytorch.org/features">About</a>
            </li>

            <li>
              <a href="https://pytorch.org/hub">Models (Beta)</a>
            </li>

            <li>
              <a href="https://pytorch.org/#community-module">Community</a>
            </li>

            <li>
              <a href="https://discuss.pytorch.org/">Forums</a>
            </li>
          </ul>

          <li>
            <a href="https://github.com/pytorch/pytorch">Github</a>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <!-- End Mobile Menu -->

  <script type="text/javascript" src="../_static/js/vendor/anchor.min.js"></script>

  <script type="text/javascript">
    $(document).ready(function() {
      mobileMenu.bind();
      mobileTOC.bind();
      pytorchAnchors.bind();
      sideMenus.bind();
      scrollToAnchor.bind();
      highlightNavigation.bind();
      mainMenuDropdown.bind();
      filterTags.bind();

      // Add class to links that have code blocks, since we cannot create links in code blocks
      $("article.pytorch-article a span.pre").each(function(e) {
        $(this).closest("a").addClass("has-code");
      });
    })
  </script>
</body>
</html>