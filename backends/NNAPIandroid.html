


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Convert MobileNetV2 to NNAPI &mdash; PyTorch Mobile .0 documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!-- <link rel="stylesheet" href="../_static/pygments.css" type="text/css" /> -->
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Core ML on iOS" href="coreMLios.html" />
    <link rel="prev" title="Using GPU on iOS (Metal Backend)" href="GPUiOS.html" />
  <!-- Google Analytics -->
  
  <!-- End Google Analytics -->
  

  
  <script src="../_static/js/modernizr.min.js"></script>

  <!-- Preload the theme fonts -->

<link rel="preload" href="../_static/fonts/FreightSans/freight-sans-book.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../_static/fonts/FreightSans/freight-sans-medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../_static/fonts/IBMPlexMono/IBMPlexMono-Medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../_static/fonts/FreightSans/freight-sans-bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../_static/fonts/FreightSans/freight-sans-medium-italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../_static/fonts/IBMPlexMono/IBMPlexMono-SemiBold.woff2" as="font" type="font/woff2" crossorigin="anonymous">

<!-- Preload the katex fonts -->

<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Math-Italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size1-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size4-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size2-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size3-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Caligraphic-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css" integrity="sha384-vSIIfh2YWi9wW0r9iZe7RJPrKwp6bG+s9QZMoITbCckVJqGCCRhc+ccxNcdpHuYu" crossorigin="anonymous">
</head>

<div class="container-fluid header-holder tutorials-header" id="header-holder">
  <div class="container">
    <div class="header-container">
      <a class="header-logo" href="https://pytorch.org/" aria-label="PyTorch"></a>

      <div class="main-menu">
        <ul>
          <li>
            <a href="https://pytorch.org/get-started">Get Started</a>
          </li>

          <li>
            <a href="https://pytorch.org/ecosystem">Ecosystem</a>
          </li>

          <li>
            <a href="https://pytorch.org/mobile">Mobile</a>
          </li>

          <li>
            <a href="https://pytorch.org/blog/">Blog</a>
          </li>

          <li>
            <a href="https://pytorch.org/tutorials">Tutorials</a>
          </li>

          <li>
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="resource-option with-down-orange-arrow">
                Docs
              </a>
              <div class="resources-dropdown-menu">
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/docs/stable/index.html">
                  <span class="dropdown-title">PyTorch</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/audio/stable/index.html">
                  <span class="dropdown-title">torchaudio</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/text/stable/index.html">
                  <span class="dropdown-title">torchtext</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/vision/stable/index.html">
                  <span class="dropdown-title">torchvision</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/elastic/">
                  <span class="dropdown-title">TorchElastic</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/serve/">
                  <span class="dropdown-title">TorchServe</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/xla">
                  <span class="dropdown-title">PyTorch on XLA Devices</span>
                  <p></p>
                </a>
            </div>
          </li>

          <li>
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="resource-option with-down-arrow">
                Resources
              </a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="https://pytorch.org/features">
                  <span class="dropdown-title">About</span>
                  <p>Learn about PyTorch’s features and capabilities</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/#community-module">
                  <span class="dropdown-title">Community</span>
                  <p>Join the PyTorch developer community to contribute, learn, and get your questions answered.</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/resources">
                  <span class="dropdown-title">Developer Resources</span>
                  <p>Find resources and get questions answered</p>
                </a>
                <a class="nav-dropdown-item" href="https://discuss.pytorch.org/" target="_blank">
                  <span class="dropdown-title">Forums</span>
                  <p>A place to discuss PyTorch code, issues, install, research</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/hub">
                  <span class="dropdown-title">Models (Beta)</span>
                  <p>Discover, publish, and reuse pre-trained models</p>
                </a>
              </div>
            </div>
          </li>

          <li>
            <a href="https://github.com/pytorch/pytorch">GitHub</a>
          </li>
        </ul>
      </div>

      <a class="main-menu-open-button" href="#" data-behavior="open-mobile-menu"></a>
    </div>
  </div>
</div>

<body class="pytorch-body">

   

    

    <div class="table-of-contents-link-wrapper">
      <span>Table of Contents</span>
      <a href="#" class="toggle-table-of-contents" data-behavior="toggle-table-of-contents"></a>
    </div>

    <nav data-toggle="wy-nav-shift" class="pytorch-left-menu" id="pytorch-left-menu">
      <div class="pytorch-side-scroll">
        <div class="pytorch-menu pytorch-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          <div class="pytorch-left-menu-search">
            

            
              
              
            

            


  


<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search Docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

            
          </div>

          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Overview</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../index.html">PyTorch Mobile</a></li>
<li class="toctree-l1"><a class="reference internal" href="../deploymentWorkflow.html">Deployment Workflow</a></li>
</ul>
<p class="caption"><span class="caption-text">Quickstart</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../quickstarts/androidquickstart.html">Android Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickstarts/iosquickstart.html">iOS Quickstart</a></li>
</ul>
<p class="caption"><span class="caption-text">Build From Source</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../androidsourcebuild.html">Building PyTorch Android from Source</a></li>
<li class="toctree-l1"><a class="reference internal" href="../iossourcebuild.html">Building PyTorch iOS from Source</a></li>
</ul>
<p class="caption"><span class="caption-text">Binary Size Optimization</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../selectivebuild/andriodSelectiveBuild.html">Andriod Selective Build</a></li>
<li class="toctree-l1"><a class="reference internal" href="../selectivebuild/iosSelectiveBuild.html">iOS Selective Build</a></li>
</ul>
<p class="caption"><span class="caption-text">Using PyTorch Libraries</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../usinglibraries/usingAndroidLibraries.html">Using the PyTorch Android Libraries</a></li>
<li class="toctree-l1"><a class="reference internal" href="../usinglibraries/usingiosLibraries.html">Using the PyTorch iOS Libraries</a></li>
</ul>
<p class="caption"><span class="caption-text">Model Preparation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../modelprep/quantization.html">Quantization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modelprep/scriptOptimizeMobile.html">Script and Optimize for Mobile</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modelprep/liteJitInterpreters.html">Lite and Full Jit Interpreters</a></li>
</ul>
<p class="caption"><span class="caption-text">Performance</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../performance/bestPractices.html">Pytorch Mobile Performance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../performance/fuseModules.html">Fuse Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../performance/andriodBenchmark.html">Andriod Benchmarking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../performance/iosBenchmark.html">iOS Benchmarking</a></li>
</ul>
<p class="caption"><span class="caption-text">Backends</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="GPUandroid.html">Using GPU on Andriod (Vulkan Backend)</a></li>
<li class="toctree-l1"><a class="reference internal" href="GPUiOS.html">Using GPU on iOS (Metal Backend)</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Convert MobileNetV2 to NNAPI</a></li>
<li class="toctree-l1"><a class="reference internal" href="coreMLios.html">Core ML on iOS</a></li>
</ul>
<p class="caption"><span class="caption-text">Custom Operators</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../customOperators.html">Andriod Native Application with Custom Operators</a></li>
</ul>
<p class="caption"><span class="caption-text">Run Inference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../runInference.html">Operator Compatibility</a></li>
</ul>
<p class="caption"><span class="caption-text">Video Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../videos/runtimeAndroid.html">PyTorch Mobile Runtime for Android</a></li>
<li class="toctree-l1"><a class="reference internal" href="../videos/runtimeiOS.html">PyTorch Mobile Runtime for iOS</a></li>
</ul>
<p class="caption"><span class="caption-text">Android Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://github.com/pytorch/android-demo-app">All Android Demo Apps</a></li>
<li class="toctree-l1"><a class="reference internal" href="../androidTutorials/androidD2Go.html">Android D2Go</a></li>
<li class="toctree-l1"><a class="reference internal" href="../androidTutorials/androidImageSegmentation.html">Image Segmentation DeepLabV3 on Android</a></li>
<li class="toctree-l1"><a class="reference internal" href="../androidTutorials/androidObjectDetection.html">Android Object Detection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../androidTutorials/androidNeuralMachineTranslation.html">Android Neural Machine Translation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../androidTutorials/androidQuestionAnswering.html">Android Question Answering</a></li>
<li class="toctree-l1"><a class="reference internal" href="../androidTutorials/androidVisionTransformer.html">Android Vision Transformer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../androidTutorials/androidSpeechRecognition.html">Android Speech Recognition</a></li>
<li class="toctree-l1"><a class="reference internal" href="../androidTutorials/androidVideoClassification.html">Android Video Classification</a></li>
</ul>
<p class="caption"><span class="caption-text">iOS Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://github.com/pytorch/ios-demo-app">All iOS Demo Apps</a></li>
<li class="toctree-l1"><a class="reference internal" href="../iosTutorials/iosD2Go.html">iOS D2Go</a></li>
<li class="toctree-l1"><a class="reference internal" href="../iosTutorials/iosImageSegmentation.html">Image Segmentation DeepLabV3 on iOS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../iosTutorials/iosObjectDetection.html">iOS Object Detection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../iosTutorials/iosNeuralMachineTranslation.html">iOS Neural Machine Translation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../iosTutorials/iosQuestionAnswering.html">iOS Question Answering</a></li>
<li class="toctree-l1"><a class="reference internal" href="../iosTutorials/iosVisionTransformer.html">iOS Vision Transformer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../iosTutorials/iosSpeechRecognition.html">iOS Speech Recognition</a></li>
<li class="toctree-l1"><a class="reference internal" href="../iosTutorials/iosVideoClassification.html">iOS Video Classification</a></li>
</ul>
<p class="caption"><span class="caption-text">API Docs</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api.html">Mobile API Docs</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <div class="pytorch-container">
      <div class="pytorch-page-level-bar" id="pytorch-page-level-bar">
        <div class="pytorch-breadcrumbs-wrapper">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="pytorch-breadcrumbs">
    
      <li>
        <a href="../contents.html">
          
            Docs
          
        </a> &gt;
      </li>

        
      <li>Convert MobileNetV2 to NNAPI</li>
    
    
      <li class="pytorch-breadcrumbs-aside">
        
            
            <a href="../_sources/backends/NNAPIandroid.rst.txt" rel="nofollow"><img src="../_static/images/view-page-source-icon.svg"></a>
          
        
      </li>
    
  </ul>

  
</div>
        </div>

        <div class="pytorch-shortcuts-wrapper" id="pytorch-shortcuts-wrapper">
          Shortcuts
        </div>
      </div>

      <section data-toggle="wy-nav-shift" id="pytorch-content-wrap" class="pytorch-content-wrap">
        <div class="pytorch-content-left">

        
          
          <div class="rst-content">
          
            <div role="main" class="main-content" itemscope="itemscope" itemtype="http://schema.org/Article">
             <article itemprop="articleBody" id="pytorch-article" class="pytorch-article">
              
  <div class="section" id="convert-mobilenetv2-to-nnapi">
<h1>Convert MobileNetV2 to NNAPI<a class="headerlink" href="#convert-mobilenetv2-to-nnapi" title="Permalink to this headline">¶</a></h1>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>This tutorial shows how to prepare a computer vision model to use
<a class="reference external" href="https://developer.android.com/ndk/guides/neuralnetworks">Android’s Neural Networks API (NNAPI)</a>.
NNAPI provides access to powerful and efficient computational cores
on many modern Android devices.</p>
<p>PyTorch’s NNAPI is currently in the “prototype” phase and only supports
a limited range of operators, but we expect to solidify the integration
and expand our operator support over time.</p>
</div>
<div class="section" id="environment">
<h2>Environment<a class="headerlink" href="#environment" title="Permalink to this headline">¶</a></h2>
<p>Install PyTorch and torchvision.
This tutorial is currently incompatible with the latest trunk,
so we recommend running
<code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">--upgrade</span> <span class="pre">--pre</span> <span class="pre">--find-links</span> <span class="pre">https://download.pytorch.org/whl/nightly/cpu/torch_nightly.html</span> <span class="pre">torch==1.8.0.dev20201106+cpu</span> <span class="pre">torchvision==0.9.0.dev20201107+cpu</span></code>
until this incompatibility is corrected.</p>
</div>
<div class="section" id="model-preparation">
<h2>Model Preparation<a class="headerlink" href="#model-preparation" title="Permalink to this headline">¶</a></h2>
<p>First, we must prepare our model to execute with NNAPI.
This step runs on your training server or laptop.
The key conversion function to call is
<code class="docutils literal notranslate"><span class="pre">torch.backends._nnapi.prepare.convert_model_to_nnapi</span></code>,
but some extra steps are required to ensure that
the model is properly structured.
Most notably, quantizing the model is required
in order to run the model on certain accelerators.</p>
<p>You can copy/paste this entire Python script and run it,
or make your own modifications.
By default, it will save the models to <code class="docutils literal notranslate"><span class="pre">~/mobilenetv2-nnapi/</span></code>.
Please create that directory first.</p>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.utils.bundled_inputs</span>
<span class="kn">import</span> <span class="nn">torch.utils.mobile_optimizer</span>
<span class="kn">import</span> <span class="nn">torch.backends._nnapi.prepare</span>
<span class="kn">import</span> <span class="nn">torchvision.models.quantization.mobilenet</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="k">import</span> <span class="n">Path</span>


<span class="c1"># This script supports 3 modes of quantization:</span>
<span class="c1"># - &quot;none&quot;: Fully floating-point model.</span>
<span class="c1"># - &quot;core&quot;: Quantize the core of the model, but wrap it a</span>
<span class="c1">#    quantizer/dequantizer pair, so the interface uses floating point.</span>
<span class="c1"># - &quot;full&quot;: Quantize the model, and use quantized tensors</span>
<span class="c1">#   for input and output.</span>
<span class="c1">#</span>
<span class="c1"># &quot;none&quot; maintains maximum accuracy</span>
<span class="c1"># &quot;core&quot; sacrifices some accuracy for performance,</span>
<span class="c1"># but maintains the same interface.</span>
<span class="c1"># &quot;full&quot; maximized performance (with the same accuracy as &quot;core&quot;),</span>
<span class="c1"># but requires the application to use quantized tensors.</span>
<span class="c1">#</span>
<span class="c1"># There is a fourth option, not supported by this script,</span>
<span class="c1"># where we include the quant/dequant steps as NNAPI operators.</span>
<span class="k">def</span> <span class="nf">make_mobilenetv2_nnapi</span><span class="p">(</span><span class="n">output_dir_path</span><span class="p">,</span> <span class="n">quantize_mode</span><span class="p">):</span>
    <span class="n">quantize_core</span><span class="p">,</span> <span class="n">quantize_iface</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;none&quot;</span><span class="p">:</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
        <span class="s2">&quot;core&quot;</span><span class="p">:</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
        <span class="s2">&quot;full&quot;</span><span class="p">:</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
    <span class="p">}[</span><span class="n">quantize_mode</span><span class="p">]</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">quantization</span><span class="o">.</span><span class="n">mobilenet</span><span class="o">.</span><span class="n">mobilenet_v2</span><span class="p">(</span><span class="n">pretrained</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">quantize</span><span class="o">=</span><span class="n">quantize_core</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>

    <span class="c1"># Fuse BatchNorm operators in the floating point model.</span>
    <span class="c1"># (Quantized models already have this done.)</span>
    <span class="c1"># Remove dropout for this inference-only use case.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">quantize_core</span><span class="p">:</span>
        <span class="n">model</span><span class="o">.</span><span class="n">fuse_model</span><span class="p">()</span>
    <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">classifier</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span>
    <span class="n">model</span><span class="o">.</span><span class="n">classifier</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Identity</span><span class="p">()</span>

    <span class="n">input_float</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">224</span><span class="p">,</span> <span class="mi">224</span><span class="p">)</span>
    <span class="n">input_tensor</span> <span class="o">=</span> <span class="n">input_float</span>

    <span class="c1"># If we&#39;re doing a quantized model, we need to trace only the quantized core.</span>
    <span class="c1"># So capture the quantizer and dequantizer, use them to prepare the input,</span>
    <span class="c1"># and replace them with identity modules so we can trace without them.</span>
    <span class="k">if</span> <span class="n">quantize_core</span><span class="p">:</span>
        <span class="n">quantizer</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">quant</span>
        <span class="n">dequantizer</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">dequant</span>
        <span class="n">model</span><span class="o">.</span><span class="n">quant</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Identity</span><span class="p">()</span>
        <span class="n">model</span><span class="o">.</span><span class="n">dequant</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Identity</span><span class="p">()</span>
        <span class="n">input_tensor</span> <span class="o">=</span> <span class="n">quantizer</span><span class="p">(</span><span class="n">input_float</span><span class="p">)</span>

    <span class="c1"># Many NNAPI backends prefer NHWC tensors, so convert our input to channels_last,</span>
    <span class="c1"># and set the &quot;nnapi_nhwc&quot; attribute for the converter.</span>
    <span class="n">input_tensor</span> <span class="o">=</span> <span class="n">input_tensor</span><span class="o">.</span><span class="n">contiguous</span><span class="p">(</span><span class="n">memory_format</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">channels_last</span><span class="p">)</span>
    <span class="n">input_tensor</span><span class="o">.</span><span class="n">nnapi_nhwc</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># Trace the model.  NNAPI conversion only works with TorchScript models,</span>
    <span class="c1"># and traced models are more likely to convert successfully than scripted.</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="n">traced</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">jit</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">input_tensor</span><span class="p">)</span>
    <span class="n">nnapi_model</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">_nnapi</span><span class="o">.</span><span class="n">prepare</span><span class="o">.</span><span class="n">convert_model_to_nnapi</span><span class="p">(</span><span class="n">traced</span><span class="p">,</span> <span class="n">input_tensor</span><span class="p">)</span>

    <span class="c1"># If we&#39;re not using a quantized interface, wrap a quant/dequant around the core.</span>
    <span class="k">if</span> <span class="n">quantize_core</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">quantize_iface</span><span class="p">:</span>
        <span class="n">nnapi_model</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="n">quantizer</span><span class="p">,</span> <span class="n">nnapi_model</span><span class="p">,</span> <span class="n">dequantizer</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">quant</span> <span class="o">=</span> <span class="n">quantizer</span>
        <span class="n">model</span><span class="o">.</span><span class="n">dequant</span> <span class="o">=</span> <span class="n">dequantizer</span>
        <span class="c1"># Switch back to float input for benchmarking.</span>
        <span class="n">input_tensor</span> <span class="o">=</span> <span class="n">input_float</span><span class="o">.</span><span class="n">contiguous</span><span class="p">(</span><span class="n">memory_format</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">channels_last</span><span class="p">)</span>

    <span class="c1"># Optimize the CPU model to make CPU-vs-NNAPI benchmarks fair.</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">mobile_optimizer</span><span class="o">.</span><span class="n">optimize_for_mobile</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">jit</span><span class="o">.</span><span class="n">script</span><span class="p">(</span><span class="n">model</span><span class="p">))</span>

    <span class="c1"># Bundle sample inputs with the models for easier benchmarking.</span>
    <span class="c1"># This step is optional.</span>
    <span class="k">class</span> <span class="nc">BundleWrapper</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mod</span><span class="p">):</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mod</span> <span class="o">=</span> <span class="n">mod</span>
        <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
    <span class="n">nnapi_model</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">jit</span><span class="o">.</span><span class="n">script</span><span class="p">(</span><span class="n">BundleWrapper</span><span class="p">(</span><span class="n">nnapi_model</span><span class="p">))</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">bundled_inputs</span><span class="o">.</span><span class="n">augment_model_with_bundled_inputs</span><span class="p">(</span>
        <span class="n">model</span><span class="p">,</span> <span class="p">[(</span><span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">bundled_inputs</span><span class="o">.</span><span class="n">bundle_large_tensor</span><span class="p">(</span><span class="n">input_tensor</span><span class="p">),)])</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">bundled_inputs</span><span class="o">.</span><span class="n">augment_model_with_bundled_inputs</span><span class="p">(</span>
        <span class="n">nnapi_model</span><span class="p">,</span> <span class="p">[(</span><span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">bundled_inputs</span><span class="o">.</span><span class="n">bundle_large_tensor</span><span class="p">(</span><span class="n">input_tensor</span><span class="p">),)])</span>

    <span class="c1"># Save both models.</span>
    <span class="n">model</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">output_dir_path</span> <span class="o">/</span> <span class="p">(</span><span class="s2">&quot;mobilenetv2-quant_</span><span class="si">{}</span><span class="s2">-cpu.pt&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">quantize_mode</span><span class="p">)))</span>
    <span class="n">nnapi_model</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">output_dir_path</span> <span class="o">/</span> <span class="p">(</span><span class="s2">&quot;mobilenetv2-quant_</span><span class="si">{}</span><span class="s2">-nnapi.pt&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">quantize_mode</span><span class="p">)))</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">quantize_mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="s2">&quot;core&quot;</span><span class="p">,</span> <span class="s2">&quot;full&quot;</span><span class="p">]:</span>
        <span class="n">make_mobilenetv2_nnapi</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;HOME&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="s2">&quot;mobilenetv2-nnapi&quot;</span><span class="p">,</span> <span class="n">quantize_mode</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="running-benchmarks">
<h2>Running Benchmarks<a class="headerlink" href="#running-benchmarks" title="Permalink to this headline">¶</a></h2>
<p>Now that the models are ready, we can benchmark them on our Android devices.
See <a class="reference external" href="https://pytorch.org/tutorials/recipes/mobile_perf.html#android-benchmarking-setup">our performance recipe</a> for details.
The best-performing models are likely to be the “fully-quantized” models:
<code class="docutils literal notranslate"><span class="pre">mobilenetv2-quant_full-cpu.pt</span></code> and <code class="docutils literal notranslate"><span class="pre">mobilenetv2-quant_full-nnapi.pt</span></code>.</p>
<p>Because these models have bundled inputs, we can run the benchmark as follows:</p>
<div class="code shell highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">./</span><span class="n">speed_benchmark_torch</span> <span class="o">--</span><span class="n">pthreadpool_size</span><span class="o">=</span><span class="mi">1</span> <span class="o">--</span><span class="n">model</span><span class="o">=</span><span class="n">mobilenetv2</span><span class="o">-</span><span class="n">quant_full</span><span class="o">-</span><span class="n">nnapi</span><span class="o">.</span><span class="n">pt</span> <span class="o">--</span><span class="n">use_bundled_input</span><span class="o">=</span><span class="mi">0</span> <span class="o">--</span><span class="n">warmup</span><span class="o">=</span><span class="mi">5</span> <span class="o">--</span><span class="nb">iter</span><span class="o">=</span><span class="mi">200</span>
</pre></div>
</div>
<p>Adjusting increasing the thread pool size can can reduce latency,
at the cost of increased CPU usage.
Omitting that argument will use one thread per big core.
The CPU models can get improved performance (at the cost of memory usage)
by passing <code class="docutils literal notranslate"><span class="pre">--use_caching_allocator=true</span></code>.</p>
</div>
<div class="section" id="integration">
<h2>Integration<a class="headerlink" href="#integration" title="Permalink to this headline">¶</a></h2>
<p>The converted models are ordinary TorchScript models.
You can use them in your app just like any other PyTorch model.
See <a class="reference external" href="https://pytorch.org/mobile/android/">https://pytorch.org/mobile/android/</a>
for an introduction to using PyTorch on Android.</p>
</div>
<div class="section" id="learn-more">
<h2>Learn More<a class="headerlink" href="#learn-more" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Learn more about optimization in our
<a class="reference external" href="https://pytorch.org/tutorials/recipes/mobile_perf.html">Mobile Performance Recipe</a></li>
<li><a class="reference external" href="https://pytorch.org/hub/pytorch_vision_mobilenet_v2/">MobileNetV2</a> from torchvision</li>
<li>Information about <a class="reference external" href="https://developer.android.com/ndk/guides/neuralnetworks">NNAPI</a></li>
</ul>
</div>
</div>


             </article>
             
            </div>
            <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="coreMLios.html" class="btn btn-neutral float-right" title="Core ML on iOS" accesskey="n" rel="next">Next <img src="../_static/images/chevron-right-orange.svg" class="next-page"></a>
      
      
        <a href="GPUiOS.html" class="btn btn-neutral" title="Using GPU on iOS (Metal Backend)" accesskey="p" rel="prev"><img src="../_static/images/chevron-right-orange.svg" class="previous-page"> Previous</a>
      
    </div>
  

  

    <hr>

  

  <div role="contentinfo">
    <p>
        &copy; Copyright 2021, Facebook.

    </p>
  </div>
    
      <div>
        Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
      </div>
     

</footer>

          </div>
        </div>

        <div class="pytorch-content-right" id="pytorch-content-right">
          <div class="pytorch-right-menu" id="pytorch-right-menu">
            <div class="pytorch-side-scroll" id="pytorch-side-scroll-right">
              <ul>
<li><a class="reference internal" href="#">Convert MobileNetV2 to NNAPI</a><ul>
<li><a class="reference internal" href="#introduction">Introduction</a></li>
<li><a class="reference internal" href="#environment">Environment</a></li>
<li><a class="reference internal" href="#model-preparation">Model Preparation</a></li>
<li><a class="reference internal" href="#running-benchmarks">Running Benchmarks</a></li>
<li><a class="reference internal" href="#integration">Integration</a></li>
<li><a class="reference internal" href="#learn-more">Learn More</a></li>
</ul>
</li>
</ul>

            </div>
          </div>
        </div>
      </section>
    </div>

  


  

     
       <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
         <script type="text/javascript" src="../_static/jquery.js"></script>
         <script type="text/javascript" src="../_static/underscore.js"></script>
         <script type="text/javascript" src="../_static/doctools.js"></script>
         <script type="text/javascript" src="../_static/language_data.js"></script>
     

  

  <script type="text/javascript" src="../_static/js/vendor/popper.min.js"></script>
  <script type="text/javascript" src="../_static/js/vendor/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/list.js/1.5.0/list.min.js"></script>
  <script type="text/javascript" src="../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>  

  <style>
    /* Sidebar header (and topbar for mobile) */
    .wy-side-nav-search, .wy-nav-top {
      background: #00ff00;
    }
    /* Sidebar */
    .wy-nav-side {
      background: #E73422;
    }
  </style>

<script script type="text/javascript">
  var collapsedSections = ['Quickstart', 'Build From Source', 'Binary Size Optimization', 'Using PyTorch Libraries', 'Model Preparation', 'Performance', 'Backends', 'Custom Operators', 'Run Inference', 'Video Tutorials', 'Android Tutorials', 'iOS Tutorials', 'API Docs'];
</script>
  


  <!-- Begin Footer -->

  <div class="container-fluid docs-tutorials-resources" id="docs-tutorials-resources">
    <div class="container">
      <div class="row">
        <div class="col-md-4 text-center">
          <h2>Docs</h2>
          <p>Access comprehensive developer documentation for PyTorch</p>
          <a class="with-right-arrow" href="https://pytorch.org/docs/stable/index.html">View Docs</a>
        </div>

        <div class="col-md-4 text-center">
          <h2>Tutorials</h2>
          <p>Get in-depth tutorials for beginners and advanced developers</p>
          <a class="with-right-arrow" href="https://pytorch.org/tutorials">View Tutorials</a>
        </div>

        <div class="col-md-4 text-center">
          <h2>Resources</h2>
          <p>Find development resources and get your questions answered</p>
          <a class="with-right-arrow" href="https://pytorch.org/resources">View Resources</a>
        </div>
      </div>
    </div>
  </div>

  <footer class="site-footer">
    <div class="container footer-container">
      <div class="footer-logo-wrapper">
        <a href="https://pytorch.org/" class="footer-logo"></a>
      </div>

      <div class="footer-links-wrapper">
        <div class="footer-links-col">
          <ul>
            <li class="list-title"><a href="https://pytorch.org/">PyTorch</a></li>
            <li><a href="https://pytorch.org/get-started">Get Started</a></li>
            <li><a href="https://pytorch.org/features">Features</a></li>
            <li><a href="https://pytorch.org/ecosystem">Ecosystem</a></li>
            <li><a href="https://pytorch.org/blog/">Blog</a></li>
            <li><a href="https://github.com/pytorch/pytorch/blob/master/CONTRIBUTING.md">Contributing</a></li>
          </ul>
        </div>

        <div class="footer-links-col">
          <ul>
            <li class="list-title"><a href="https://pytorch.org/resources">Resources</a></li>
            <li><a href="https://pytorch.org/tutorials">Tutorials</a></li>
            <li><a href="https://pytorch.org/docs/stable/index.html">Docs</a></li>
            <li><a href="https://discuss.pytorch.org" target="_blank">Discuss</a></li>
            <li><a href="https://github.com/pytorch/pytorch/issues" target="_blank">Github Issues</a></li>
            <li><a href="https://pytorch.org/assets/brand-guidelines/PyTorch-Brand-Guidelines.pdf" target="_blank">Brand Guidelines</a></li>
          </ul>
        </div>

        <div class="footer-links-col follow-us-col">
          <ul>
            <li class="list-title">Stay Connected</li>
            <li>
              <div id="mc_embed_signup">
                <form
                  action="https://twitter.us14.list-manage.com/subscribe/post?u=75419c71fe0a935e53dfa4a3f&id=91d0dccd39"
                  method="post"
                  id="mc-embedded-subscribe-form"
                  name="mc-embedded-subscribe-form"
                  class="email-subscribe-form validate"
                  target="_blank"
                  novalidate>
                  <div id="mc_embed_signup_scroll" class="email-subscribe-form-fields-wrapper">
                    <div class="mc-field-group">
                      <label for="mce-EMAIL" style="display:none;">Email Address</label>
                      <input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL" placeholder="Email Address">
                    </div>

                    <div id="mce-responses" class="clear">
                      <div class="response" id="mce-error-response" style="display:none"></div>
                      <div class="response" id="mce-success-response" style="display:none"></div>
                    </div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->

                    <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_75419c71fe0a935e53dfa4a3f_91d0dccd39" tabindex="-1" value=""></div>

                    <div class="clear">
                      <input type="submit" value="" name="subscribe" id="mc-embedded-subscribe" class="button email-subscribe-button">
                    </div>
                  </div>
                </form>
              </div>

            </li>
          </ul>

          <div class="footer-social-icons">
            <a href="https://www.facebook.com/pytorch" target="_blank" class="facebook"></a>
            <a href="https://twitter.com/pytorch" target="_blank" class="twitter"></a>
            <a href="https://www.youtube.com/pytorch" target="_blank" class="youtube"></a>
          </div>
        </div>
      </div>
    </div>
  </footer>

  <div class="cookie-banner-wrapper">
  <div class="container">
    <p class="gdpr-notice">To analyze traffic and optimize your experience, we serve cookies on this site. By clicking or navigating, you agree to allow our usage of cookies. As the current maintainers of this site, Facebook’s Cookies Policy applies. Learn more, including about available controls: <a href="https://www.facebook.com/policies/cookies/">Cookies Policy</a>.</p>
    <img class="close-button" src="../_static/images/pytorch-x.svg">
  </div>
</div>

  <!-- End Footer -->

  <!-- Begin Mobile Menu -->

  <div class="mobile-main-menu">
    <div class="container-fluid">
      <div class="container">
        <div class="mobile-main-menu-header-container">
          <a class="header-logo" href="https://pytorch.org/" aria-label="PyTorch"></a>
          <a class="main-menu-close-button" href="#" data-behavior="close-mobile-menu"></a>
        </div>
      </div>
    </div>

    <div class="mobile-main-menu-links-container">
      <div class="main-menu">
        <ul>
          <li>
            <a href="https://pytorch.org/get-started">Get Started</a>
          </li>

          <li>
            <a href="https://pytorch.org/ecosystem">Ecosystem</a>
          </li>

          <li>
            <a href="https://pytorch.org/mobile">Mobile</a>
          </li>

          <li>
            <a href="https://pytorch.org/hub">PyTorch Hub</a>
          </li>

          <li>
            <a href="https://pytorch.org/blog/">Blog</a>
          </li>

          <li>
            <a href="https://pytorch.org/tutorials">Tutorials</a>
          </li>

          <li class="resources-mobile-menu-title">
            Docs
          </li>

          <ul class="resources-mobile-menu-items">
            <li>
              <a href="https://pytorch.org/docs/stable/index.html">PyTorch</a>
            </li>

            <li>
              <a href="https://pytorch.org/audio/stable/index.html">torchaudio</a>
            </li>

            <li>
              <a href="https://pytorch.org/text/stable/index.html">torchtext</a>
            </li>

            <li>
              <a href="https://pytorch.org/vision/stable/index.html">torchvision</a>
            </li>

            <li>
              <a href="https://pytorch.org/elastic/">TorchElastic</a>
            </li>

            <li>
              <a href="https://pytorch.org/serve/">TorchServe</a>
            </li>

            <li>
              <a href="https://pytorch.org/xla">PyTorch on XLA Devices</a>
            </li>
          </ul>

          <li class="resources-mobile-menu-title">
            Resources
          </li>

          <ul class="resources-mobile-menu-items">
            <li>
              <a href="https://pytorch.org/resources">Developer Resources</a>
            </li>

            <li>
              <a href="https://pytorch.org/features">About</a>
            </li>

            <li>
              <a href="https://pytorch.org/hub">Models (Beta)</a>
            </li>

            <li>
              <a href="https://pytorch.org/#community-module">Community</a>
            </li>

            <li>
              <a href="https://discuss.pytorch.org/">Forums</a>
            </li>
          </ul>

          <li>
            <a href="https://github.com/pytorch/pytorch">Github</a>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <!-- End Mobile Menu -->

  <script type="text/javascript" src="../_static/js/vendor/anchor.min.js"></script>

  <script type="text/javascript">
    $(document).ready(function() {
      mobileMenu.bind();
      mobileTOC.bind();
      pytorchAnchors.bind();
      sideMenus.bind();
      scrollToAnchor.bind();
      highlightNavigation.bind();
      mainMenuDropdown.bind();
      filterTags.bind();

      // Add class to links that have code blocks, since we cannot create links in code blocks
      $("article.pytorch-article a span.pre").each(function(e) {
        $(this).closest("a").addClass("has-code");
      });
    })
  </script>
</body>
</html>